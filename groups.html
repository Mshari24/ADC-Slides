<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Groups</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body class="home-body">
  <div class="home-root">
    <aside class="home-sidebar" aria-label="Primary navigation">
      <div class="sidebar-user">
        <div class="sidebar-avatar" aria-hidden="true">MA</div>
      </div>
      <a class="sb-item home-entry" href="./home.html" title="Home">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <span class="sb-label">Home</span>
      </a>
      <a class="sb-item new-entry" href="./index.html" title="New">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </div>
        <span class="sb-label">New</span>
      </a>
      <a class="sb-item active" href="./groups.html" title="Groups">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="sb-label">Groups</span>
      </a>
    </aside>

    <main class="home-main">
      <header class="home-top">
        <div class="top-brand">
          <img src="./pic/aramco-digital.png" alt="Aramco Digital" class="brand-logo" />
          <div class="brand-meta">
            <span class="brand-title">AD Slides</span>
            <span class="brand-subtitle">Group collaboration hub</span>
          </div>
        </div>
        <button id="btn-top-notifications" class="icon-button" type="button" aria-label="Notifications">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span class="badge" id="notif-count" aria-hidden="true">1</span>
        </button>
        <div class="notification-panel hidden" id="notification-panel">
          <h3>Notifications</h3>
          <ul>
            <li>New members awaiting approval in ESG Council.</li>
            <li>Neptune Migration agenda draft shared.</li>
          </ul>
        </div>
      </header>

      <section class="groups-shell">
        <div class="panel group-create-panel">
          <div class="panel-head">
            <div>
              <h2>Create new group</h2>
              <p class="panel-subtitle">Spin up collaboration spaces in seconds</p>
            </div>
          </div>
          <div class="group-create-actions">
            <button class="group-create-card" type="button" id="btn-create-group">
              <span class="group-create-icon">＋</span>
              <span class="group-create-title">Create blank group</span>
              <span class="group-create-meta">Define name, description, and members</span>
            </button>
            <button class="group-create-card" type="button" id="btn-import-group">
              <span class="group-create-icon">⇪</span>
              <span class="group-create-title">Import roster</span>
              <span class="group-create-meta">Upload CSV or connect Outlook group</span>
            </button>
          </div>
        </div>

        <div class="panel group-icon-panel">
          <div class="panel-head">
            <div>
              <h2>Active groups</h2>
              <p class="panel-subtitle">Tap a group icon to open conversation</p>
            </div>
          </div>
          <div class="group-icon-grid" id="group-icon-grid"></div>
        </div>

        <div class="panel group-chat-panel hidden" id="group-chat-panel">
          <header class="group-chat-header">
            <div class="group-chat-title">
              <span class="group-pill" id="group-tag">Engineering</span>
              <h2 id="group-title">Neptune Migration</h2>
              <p id="group-description">Steering committee for platform modernisation.</p>
            </div>
            <div class="group-chat-metrics">
              <div class="group-metric">
                <span class="metric-label">Owner</span>
                <span class="metric-value" id="group-owner">noor.ahmed@adslab.com</span>
              </div>
              <div class="group-metric">
                <span class="metric-label">Next review</span>
                <span class="metric-value" id="group-review">Nov 24, 2025</span>
              </div>
              <div class="group-metric">
                <span class="metric-label">Members</span>
                <span class="metric-value" id="group-members">18</span>
              </div>
            </div>
          </header>
          <ul id="group-points" class="group-points"></ul>
          <div class="chat-timeline" id="chat-timeline"></div>
          <form id="chat-form" class="chat-composer">
            <input id="chat-input" type="text" placeholder="Share an update with the group…" autocomplete="off" />
            <button class="btn-primary" type="submit">Send</button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <div id="create-group-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cg-title">
      <h3 id="cg-title">Create new group</h3>
      <form id="create-group-form">
        <label class="form-item">
          <span>Group name</span>
          <input id="group-name" type="text" placeholder="e.g. Transformation PMO" required />
        </label>
        <label class="form-item">
          <span>Description</span>
          <textarea id="group-description" rows="3" placeholder="What is this group for?"></textarea>
        </label>
        <label class="form-item">
          <span>Add members</span>
          <textarea id="members-input" rows="3" placeholder="Enter emails"></textarea>
        </label>
        <div class="modal-actions">
          <button type="button" id="cg-cancel" class="btn">Cancel</button>
          <button type="submit" class="btn-primary">Create group</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const computeInitials = (value) => {
        if (!value) return '';
        const parts = value.replace(/[\.\_\-]+/g, ' ').trim().split(/\s+/).filter(Boolean);
        if (parts.length) {
          return parts.map((part) => part.charAt(0).toUpperCase()).join('').slice(0, 2);
        }
        return value.slice(0, 2).toUpperCase();
      };

      let storedInitials = '';
      let storedName = '';
      let storedEmail = '';
      try {
        storedInitials = window.localStorage.getItem('adSlidesUserInitials') || '';
        storedName = window.localStorage.getItem('adSlidesUserName') || '';
        storedEmail = window.localStorage.getItem('adSlidesUserEmail') || '';
      } catch (error) {
        console.warn('Unable to access stored user profile', error);
      }

      const avatar = document.querySelector('.sidebar-avatar');
      if (avatar) {
        const initials = storedInitials || computeInitials(storedName) || computeInitials(storedEmail) || 'AD';
        avatar.textContent = initials;
      }

      const notifButton = document.getElementById('btn-top-notifications');
      const notifCount = document.getElementById('notif-count');
      const notifPanel = document.getElementById('notification-panel');
      const groupIconGrid = document.getElementById('group-icon-grid');
      const chatPanel = document.getElementById('group-chat-panel');
      const chatTimeline = document.getElementById('chat-timeline');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const overviewTitle = document.getElementById('group-title');
      const overviewTag = document.getElementById('group-tag');
      const overviewOwner = document.getElementById('group-owner');
      const overviewReview = document.getElementById('group-review');
      const overviewMembers = document.getElementById('group-members');
      const overviewDescription = document.getElementById('group-description');
      const overviewPoints = document.getElementById('group-points');
      const modal = document.getElementById('create-group-modal');
      const btnCreateGroup = document.getElementById('btn-create-group');
      const btnImportGroup = document.getElementById('btn-import-group');
      const btnCancel = document.getElementById('cg-cancel');
      const form = document.getElementById('create-group-form');

      const showToast = (msg) => {
        const el = document.createElement('div');
        el.textContent = msg;
        el.style.position = 'fixed';
        el.style.bottom = '16px';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.background = '#111827';
        el.style.color = '#fff';
        el.style.padding = '10px 14px';
        el.style.borderRadius = '10px';
        el.style.zIndex = '9999';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1600);
      };

      notifButton?.addEventListener('click', () => {
        notifPanel?.classList.toggle('hidden');
        notifCount?.classList.add('hidden');
      });

      document.addEventListener('click', (event) => {
        if (!event.target.closest('.home-top') && !notifPanel?.classList.contains('hidden')) {
          notifPanel.classList.add('hidden');
        }
      });

      const groupsData = [
        {
          id: 'neptune',
          name: 'Neptune Migration',
          tag: 'Engineering',
          members: 18,
          owner: 'noor.ahmed@adslab.com',
          review: 'Nov 24, 2025',
          description: 'Stabilise data pipelines and finalise automation rollout for core sites.',
          points: [
            'Finalise site readiness checklist by Nov 18',
            'Distribute automation briefing to regional leads',
            'Prep steering deck for executive review'
          ],
          chat: [
            { author: 'Layla Ismail', role: 'Design lead', time: '09:10', message: 'Slides 6-8 refreshed with the updated site metrics.' },
            { author: 'Ahmed Ali', role: 'Strategy', time: '09:22', message: 'Added risk appendix requested by finance.' },
            { author: 'You', role: 'Owner', time: '09:40', message: 'Great work—will spotlight these changes in tomorrow’s brief.', self: true }
          ]
        },
        {
          id: 'esg',
          name: 'ESG Council',
          tag: 'Sustainability',
          members: 12,
          owner: 'layla.ismail@adslab.com',
          review: 'Dec 02, 2025',
          description: 'Cross-functional council aligning ESG narrative, data, and stakeholder outreach.',
          points: [
            'Publish emissions dashboard update by Nov 20',
            'Align talking points with investor relations',
            'Coordinate December townhall narrative'
          ],
          chat: [
            { author: 'Khalid Hassan', role: 'Policy', time: '08:55', message: 'Draft narrative uploaded—please review focus slide 4.' },
            { author: 'You', role: 'Moderator', time: '09:05', message: 'Will circulate to investor relations once comms signs off.', self: true }
          ]
        }
      ];

      let currentGroup = null;

      const renderIcons = () => {
        groupIconGrid.innerHTML = '';
        groupsData.forEach(group => {
          const initials = group.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
          const button = document.createElement('button');
          button.className = 'group-icon-button';
          if (currentGroup && group.id === currentGroup.id) button.classList.add('active');
          button.dataset.id = group.id;
          button.innerHTML = `
            <span class="group-icon-avatar">${initials}</span>
            <span class="group-icon-label">${group.name}</span>
          `;
          button.addEventListener('click', () => selectGroup(group.id));
          groupIconGrid.appendChild(button);
        });
      };

      const renderOverview = (group) => {
        overviewTitle.textContent = group.name;
        overviewTag.textContent = group.tag;
        overviewOwner.textContent = group.owner;
        overviewReview.textContent = group.review;
        overviewMembers.textContent = group.members;
        overviewDescription.textContent = group.description;
        overviewPoints.innerHTML = group.points
          .map(point => `<li><span class="point-bullet"></span><span>${point}</span></li>`)
          .join('');
      };

      const renderChat = (group) => {
        if (!group) {
          chatPanel.classList.add('hidden');
          return;
        }

        chatPanel.classList.remove('hidden');
        chatTimeline.innerHTML = '';

        if (!group.chat.length) {
          chatTimeline.innerHTML = '<div class="chat-empty">No messages yet. Start the conversation below.</div>';
          return;
        }

        group.chat.forEach(entry => {
          const message = document.createElement('div');
          message.className = 'chat-message' + (entry.self ? ' is-self' : '');
          message.innerHTML = `
            <div class="chat-meta">
              <span class="chat-author">${entry.author}</span>
              ${entry.role ? `<span class="chat-role">${entry.role}</span>` : ''}
              <span class="chat-time">${entry.time}</span>
            </div>
            <div class="chat-text">${entry.message}</div>
          `;
          chatTimeline.appendChild(message);
        });

        chatTimeline.scrollTop = chatTimeline.scrollHeight;
      };

      const selectGroup = (id) => {
        const found = groupsData.find(g => g.id === id);
        if (!found) return;
        currentGroup = found;
        renderIcons();
        renderOverview(found);
        renderChat(found);
      };

      renderIcons();
      renderChat(null);

      chatForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const value = chatInput.value.trim();
        if (!value || !currentGroup) return;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        currentGroup.chat.push({ author: 'You', role: 'Owner', time, message: value, self: true });
        chatInput.value = '';
        renderChat(currentGroup);
      });

      const openModal = () => modal.classList.remove('hidden');
      const closeModal = () => {
        modal.classList.add('hidden');
        form.reset();
      };

      btnCreateGroup?.addEventListener('click', openModal);
      btnCancel?.addEventListener('click', closeModal);
      modal.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);

      btnImportGroup?.addEventListener('click', () => {
        showToast('Roster import coming soon (demo).');
      });

      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('group-name').value.trim() || 'Untitled group';
        const description = document.getElementById('group-description').value.trim() || 'Description pending';

        const newGroup = {
          id: `grp-${Date.now()}`,
          name,
          tag: 'Custom',
          members: 1,
          owner: 'you@adslab.com',
          review: 'Set review date',
          description,
          points: [
            'Define charter and success measures',
            'Invite core stakeholders',
            'Schedule first sync session'
          ],
          chat: []
        };

        groupsData.unshift(newGroup);
        selectGroup(newGroup.id);
        closeModal();
        showToast(`Group "${name}" created`);
      });
    })();
  </script>
</body>
</html>


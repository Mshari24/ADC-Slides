<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Groups</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body class="home-body groups-page">
  <div class="home-root">
    <aside class="home-sidebar" aria-label="Primary navigation">
      <div class="sidebar-user">
        <a class="sidebar-avatar-link" href="/profile/" title="User Profile &amp; Settings" aria-label="Open profile page">
          <div class="sidebar-avatar" aria-hidden="true">MA</div>
        </a>
      </div>
      <a class="sb-item home-entry" href="./home.html" title="Home">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <span class="sb-label">Home</span>
      </a>
      <div class="sb-item new-entry" role="button" tabindex="0" data-default-href="./index.html" aria-haspopup="true" aria-expanded="false">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </div>
        <span class="sb-label">New</span>
        <div class="new-menu tw-transition-all tw-duration-200 tw-ease-out tw-opacity-0 tw-pointer-events-none" role="menu" aria-label="Create presentation options" data-new-menu>
          <span class="new-menu-heading">Start a deck</span>
          <div class="new-menu-options">
            <button type="button" class="new-menu-item" data-new-action="blank" data-new-href="./index.html">
              <span class="new-menu-icon">＋</span>
              <span class="new-menu-text">
                <strong>Blank presentation</strong>
                <small>Empty canvas, 16:9 layout</small>
              </span>
            </button>
            <button type="button" class="new-menu-item" data-new-action="template" data-new-href="./index.html?template=ad">
              <span class="new-menu-icon">✦</span>
              <span class="new-menu-text">
                <strong>AD template</strong>
                <small>Aramco Digital branded masters</small>
              </span>
            </button>
          </div>
        </div>
      </div>
      <a class="sb-item active" href="./groups.html" title="Groups">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="sb-label">Groups</span>
      </a>
      <a class="sb-item" href="./project.html" title="Projects">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            <path d="M12 9v6"></path>
            <path d="M9 12h6"></path>
          </svg>
        </div>
        <span class="sb-label">Projects</span>
      </a>
      <a class="sb-item" href="https://outlook.office.com/mail/" target="_blank" rel="noopener noreferrer" title="Outlook">
        <div class="sb-icon">
          <img src="./pic/Outlook_on_the_web-Logo.wine.png" alt="Outlook" />
        </div>
        <span class="sb-label">Outlook</span>
      </a>
      <a class="sb-item" href="https://teams.microsoft.com/" target="_blank" rel="noopener noreferrer" title="Microsoft Teams">
        <div class="sb-icon">
          <img src="./pic/Microsoft-Teams-Logo.png" alt="Microsoft Teams" />
        </div>
        <span class="sb-label">Teams</span>
      </a>
      <a class="sb-item logout-link" href="./login.html" title="Log out">
        <div class="sb-icon logout-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </div>
        <span class="sb-label">Logout</span>
      </a>
    </aside>

    <main class="home-main">
      <header class="home-top">
        <div class="top-brand">
          <img src="./pic/aramco-digital.png" alt="Aramco Digital" class="brand-logo" />
          <div class="brand-meta">
            <span class="brand-title">AD Slides</span>
            <span class="brand-subtitle">Group collaboration hub</span>
          </div>
        </div>
        <div class="home-top-actions">
          <button id="btn-top-notifications" class="icon-button" type="button" aria-label="Notifications" aria-haspopup="dialog" aria-expanded="false">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="badge" id="notif-count" aria-hidden="true">3</span>
          </button>
          <div class="notification-panel hidden" id="notification-panel" role="dialog" aria-modal="false" aria-labelledby="notifications-title" aria-hidden="true" tabindex="-1">
            <div class="notification-panel-head">
              <h3 id="notifications-title">Notifications</h3>
              <button class="notification-panel-action" type="button" data-notification-mark-read>Mark all read</button>
            </div>
            <p class="notification-empty hidden" data-notification-empty>You're all caught up.</p>
            <ul class="notification-list" data-notification-list aria-live="polite"></ul>
            <div class="notification-panel-footer">
              <a class="notification-panel-link" data-notification-see-all href="./notification.html">See All</a>
            </div>
          </div>
        </div>
      </header>

      <section class="groups-decks">
        <div class="deck create-group-deck">
          <div class="deck-header">
            <h2 class="deck-title">Create Group</h2>
            <p class="deck-subtitle">Start a new collaboration space</p>
          </div>
          <div class="deck-content">
            <div class="create-group-options">
              <button class="create-option-card" type="button" id="btn-create-group">
                <div class="option-icon">＋</div>
                <div class="option-content">
                  <h3>Create blank group</h3>
                  <p>Define name, description, and members manually</p>
                </div>
              </button>
            </div>
            <div class="groups-list-section">
              <div class="list-header">
                <h3>Your Groups</h3>
                <input id="group-search" type="search" placeholder="Search groups…" autocomplete="off" class="group-search-input" />
              </div>
              <div id="group-list" class="group-list"></div>
            </div>
          </div>
        </div>

        <div class="deck chat-deck hidden" id="group-chat-panel">
          <div class="deck-header">
            <div class="chat-header-info">
              <span class="group-pill" id="group-tag">Engineering</span>
              <h2 class="deck-title" id="group-title">Select a group</h2>
            </div>
            <div class="chat-header-meta">
              <div class="meta-item">
                <span class="meta-label">Members</span>
                <span class="meta-value" id="group-members">0</span>
              </div>
            </div>
          </div>
          <div class="deck-content">
            <div class="chat-container">
              <aside class="chat-members">
                <h3 class="chat-members-title">Members</h3>
                <ul class="chat-members-list" id="chat-members-list"></ul>
              </aside>
              <div class="chat-main">
                <div class="chat-timeline" id="chat-timeline">
                  <div class="chat-empty">Select a group from the left to start chatting.</div>
                </div>
                <form id="chat-form" class="chat-composer">
                  <input id="chat-input" type="text" placeholder="Share an update with the group…" autocomplete="off" />
                  <button class="btn-primary" type="submit">Send</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="create-group-modal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cg-title">
      <h3 id="cg-title">Create new group</h3>
      <form id="create-group-form">
        <label class="form-item">
          <span>Group name</span>
          <input id="group-name" type="text" placeholder="e.g. Transformation PMO" required />
        </label>
        <label class="form-item">
          <span>Description</span>
          <textarea id="group-description" rows="3" placeholder="What is this group for?"></textarea>
        </label>
        <label class="form-item">
          <span>Add members</span>
          <textarea id="members-input" rows="3" placeholder="Enter emails"></textarea>
        </label>
        <div class="modal-actions">
          <button type="button" id="cg-cancel" class="btn">Cancel</button>
          <button type="submit" class="btn-primary">Create group</button>
        </div>
      </form>
    </div>
  </div>

  <script src="./notifications.js"></script>
  <script>
    (function () {
      const computeInitials = (value) => {
        if (!value) return '';
        const parts = value.replace(/[\.\_\-]+/g, ' ').trim().split(/\s+/).filter(Boolean);
        if (parts.length) {
          return parts.map((part) => part.charAt(0).toUpperCase()).join('').slice(0, 2);
        }
        return value.slice(0, 2).toUpperCase();
      };

      let storedInitials = '';
      let storedName = '';
      let storedEmail = '';
      try {
        storedInitials = window.localStorage.getItem('adSlidesUserInitials') || '';
        storedName = window.localStorage.getItem('adSlidesUserName') || '';
        storedEmail = window.localStorage.getItem('adSlidesUserEmail') || '';
      } catch (error) {
        console.warn('Unable to access stored user profile', error);
      }

      const avatar = document.querySelector('.sidebar-avatar');
      if (avatar) {
        const initials = storedInitials || computeInitials(storedName) || computeInitials(storedEmail) || 'AD';
        avatar.textContent = initials;
      }

      const setupSidebarNewMenu = () => {
        const entry = document.querySelector('.home-sidebar .new-entry');
        if (!entry) return;
        const menu = entry.querySelector('[data-new-menu]');
        if (!menu) return;

        const menuItems = Array.from(menu.querySelectorAll('[data-new-href]'));
        const defaultHref = entry.dataset.defaultHref || menuItems[0]?.dataset.newHref || './index.html';
        let isOpen = false;

        const handleDocumentClick = (event) => {
          if (!entry.contains(event.target)) {
            setOpen(false);
          }
        };

        const setOpen = (state) => {
          if (isOpen === state) return;
          isOpen = state;
          entry.dataset.open = state ? 'true' : 'false';
          entry.setAttribute('aria-expanded', state ? 'true' : 'false');
          menu.classList.toggle('tw-opacity-0', !state);
          menu.classList.toggle('tw-opacity-100', state);
          menu.classList.toggle('tw-pointer-events-none', !state);
          menu.classList.toggle('tw-pointer-events-auto', state);

          if (state) {
            document.addEventListener('click', handleDocumentClick);
          } else {
            document.removeEventListener('click', handleDocumentClick);
          }
        };

        const toggleMenu = () => setOpen(!isOpen);

        entry.addEventListener('click', (event) => {
          const actionTarget = event.target.closest('[data-new-href]');
          if (actionTarget) {
            return;
          }
          event.preventDefault();
          setOpen(true);
        });

        entry.addEventListener('mouseenter', () => setOpen(true));

        entry.addEventListener('mouseleave', () => {
          if (isOpen) {
            setOpen(false);
          }
        });

        entry.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            toggleMenu();
          } else if (event.key === 'Escape' && isOpen) {
            event.preventDefault();
            setOpen(false);
            entry.blur();
          } else if ((event.key === 'ArrowDown' || event.key === 'ArrowUp') && !isOpen) {
            event.preventDefault();
            setOpen(true);
            (menuItems[0] || entry).focus();
          }
        });

        menu.addEventListener('click', (event) => {
          event.stopPropagation();
        });

        menu.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && isOpen) {
            event.preventDefault();
            setOpen(false);
            entry.focus();
          }
        });

        entry.addEventListener('focusout', (event) => {
          if (!entry.contains(event.relatedTarget)) {
            setOpen(false);
          }
        });

        menu.addEventListener('focusout', (event) => {
          if (!menu.contains(event.relatedTarget)) {
            setOpen(false);
          }
        });

        menuItems.forEach((button) => {
          button.addEventListener('click', (event) => {
            event.stopPropagation();
            const target = button.dataset.newHref || defaultHref;
            setOpen(false);
            if (target) {
              window.location.href = target;
            }
          });
        });
      };

      setupSidebarNewMenu();

      const groupList = document.getElementById('group-list');
      const groupSearch = document.getElementById('group-search');
      const chatPanel = document.getElementById('group-chat-panel');
      const chatTimeline = document.getElementById('chat-timeline');
      const chatMembersList = document.getElementById('chat-members-list');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const groupTitle = document.getElementById('group-title');
      const groupTag = document.getElementById('group-tag');
      const groupMembers = document.getElementById('group-members');
      const modal = document.getElementById('create-group-modal');
      const btnCancel = document.getElementById('cg-cancel');
      const form = document.getElementById('create-group-form');

      const showToast = (msg) => {
        const el = document.createElement('div');
        el.textContent = msg;
        el.style.position = 'fixed';
        el.style.bottom = '16px';
        el.style.left = '50%';
        el.style.transform = 'translateX(-50%)';
        el.style.background = '#111827';
        el.style.color = '#fff';
        el.style.padding = '10px 14px';
        el.style.borderRadius = '10px';
        el.style.zIndex = '9999';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1600);
      };

      window.ADCNotifications?.refresh?.();

      const groupsData = [
        {
          id: 'neptune',
          name: 'Neptune Migration',
          tag: 'Engineering',
          members: 18,
          owner: 'noor.ahmed@adslab.com',
          review: 'Nov 24, 2025',
          description: 'Stabilise data pipelines and finalise automation rollout for core sites.',
          points: [
            'Finalise site readiness checklist by Nov 18',
            'Distribute automation briefing to regional leads',
            'Prep steering deck for executive review'
          ],
          chat: [
            { author: 'Layla Ismail', role: 'Design lead', time: '09:10', message: 'Slides 6-8 refreshed with the updated site metrics.' },
            { author: 'Ahmed Ali', role: 'Strategy', time: '09:22', message: 'Added risk appendix requested by finance.' },
            { author: 'You', role: 'Owner', time: '09:40', message: 'Great work—will spotlight these changes in tomorrow’s brief.', self: true }
          ]
        },
        {
          id: 'esg',
          name: 'ESG Council',
          tag: 'Sustainability',
          members: 12,
          owner: 'layla.ismail@adslab.com',
          review: 'Dec 02, 2025',
          description: 'Cross-functional council aligning ESG narrative, data, and stakeholder outreach.',
          points: [
            'Publish emissions dashboard update by Nov 20',
            'Align talking points with investor relations',
            'Coordinate December townhall narrative'
          ],
          chat: [
            { author: 'Khalid Hassan', role: 'Policy', time: '08:55', message: 'Draft narrative uploaded—please review focus slide 4.' },
            { author: 'You', role: 'Moderator', time: '09:05', message: 'Will circulate to investor relations once comms signs off.', self: true }
          ]
        }
      ];

      let currentGroup = null;

      const getInitials = (value = '') => {
        const trimmed = value.trim();
        if (!trimmed) return 'NA';
        const parts = trimmed.split(/\s+/);
        if (parts.length === 1) {
          return parts[0].slice(0, 2).toUpperCase();
        }
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      };


      const renderGroupList = (query = '') => {
        if (!groupList) return;
        const q = query.trim().toLowerCase();
        let matches = 0;
        groupList.innerHTML = '';

        groupsData.forEach(group => {
          const matchesQuery =
            !q ||
            group.name.toLowerCase().includes(q) ||
            (group.tag && group.tag.toLowerCase().includes(q));
          if (!matchesQuery) {
            return;
          }
          matches += 1;
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'group-list-item';
          if (currentGroup && group.id === currentGroup.id) {
            button.classList.add('is-active');
          }
          button.dataset.id = group.id;
          const initials = group.name.split(' ').map(word => word.charAt(0)).join('').slice(0, 2).toUpperCase();
          button.innerHTML = `
            <span class="group-list-initials">${initials}</span>
            <span class="group-list-copy">
              <span class="group-list-name">${group.name}</span>
              <span class="group-list-meta">${group.tag} • ${group.members} members</span>
            </span>
          `;
          button.addEventListener('click', () => selectGroup(group.id));
          groupList.appendChild(button);
        });

        if (!matches) {
          groupList.innerHTML = '<div class="group-list-empty">No groups match your search. Try a different keyword.</div>';
        }
      };

      const renderChat = (group) => {
        if (!group) {
          chatPanel?.classList.add('hidden');
          return;
        }

        chatPanel?.classList.remove('hidden');
        chatTimeline.innerHTML = '';
        chatMembersList.innerHTML = '';

        // Update header
        if (groupTitle) groupTitle.textContent = group.name;
        if (groupTag) groupTag.textContent = group.tag;
        if (groupMembers) groupMembers.textContent = group.members;

        // Extract unique members from chat messages
        const membersMap = new Map();
        group.chat.forEach(entry => {
          if (!membersMap.has(entry.author)) {
            membersMap.set(entry.author, {
              name: entry.author,
              role: entry.role || '',
              isSelf: entry.self || false
            });
          }
        });

        // Render member list
        const sortedMembers = Array.from(membersMap.values()).sort((a, b) => {
          if (a.isSelf) return -1;
          if (b.isSelf) return 1;
          return a.name.localeCompare(b.name);
        });

        if (sortedMembers.length) {
          sortedMembers.forEach(member => {
            const memberItem = document.createElement('li');
            memberItem.className = 'chat-member-item' + (member.isSelf ? ' is-self' : '');
            memberItem.innerHTML = `
              <span class="chat-member-avatar">${getInitials(member.name)}</span>
              <span class="chat-member-text">
                <span class="chat-member-name">${member.name}</span>
                ${member.role ? `<span class="chat-member-role">${member.role}</span>` : ''}
              </span>
            `;
            chatMembersList.appendChild(memberItem);
          });
        } else {
          chatMembersList.innerHTML = '<li class="chat-member-item is-empty">No contributors yet. Share the first update.</li>';
        }

        // Render chat messages
        if (!group.chat.length) {
          chatTimeline.innerHTML = '<div class="chat-empty">No messages yet. Start the conversation below.</div>';
          return;
        }

        group.chat.forEach(entry => {
          const message = document.createElement('div');
          message.className = 'chat-message' + (entry.self ? ' is-self' : '');
          message.innerHTML = `
            <div class="chat-bubble">
              <span class="chat-avatar">${getInitials(entry.author)}</span>
              <div class="chat-content">
                <div class="chat-meta">
                  <span class="chat-author">${entry.author}</span>
                  ${entry.role ? `<span class="chat-role">${entry.role}</span>` : ''}
                </div>
                <div class="chat-text">${entry.message}</div>
              </div>
            </div>
          `;
          chatTimeline.appendChild(message);
        });

        chatTimeline.scrollTop = chatTimeline.scrollHeight;
      };

      const selectGroup = (id) => {
        const found = groupsData.find(g => g.id === id);
        if (!found) return;
        currentGroup = found;
        renderGroupList(groupSearch?.value || '');
        renderChat(found);
      };

      renderGroupList();
      if (groupsData.length) {
        selectGroup(groupsData[0].id);
      } else {
        chatPanel?.classList.add('hidden');
      }

      chatForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const value = chatInput.value.trim();
        if (!value || !currentGroup) return;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        currentGroup.chat.push({ author: 'You', role: 'Owner', time, message: value, self: true });
        chatInput.value = '';
        renderChat(currentGroup);
      });

      groupSearch?.addEventListener('input', (event) => {
        renderGroupList(event.target.value);
      });

      const openModal = () => modal.classList.remove('hidden');
      const closeModal = () => {
        modal.classList.add('hidden');
        form.reset();
      };

      const btnCreateGroup = document.getElementById('btn-create-group');

      btnCreateGroup?.addEventListener('click', openModal);
      btnCancel?.addEventListener('click', closeModal);
      modal.querySelector('.modal-backdrop')?.addEventListener('click', closeModal);

      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('group-name').value.trim() || 'Untitled group';
        const description = document.getElementById('group-description').value.trim() || 'Description pending';

        const newGroup = {
          id: `grp-${Date.now()}`,
          name,
          tag: 'Custom',
          members: 1,
          owner: 'you@adslab.com',
          review: 'Set review date',
          description,
          points: [
            'Define charter and success measures',
            'Invite core stakeholders',
            'Schedule first sync session'
          ],
          chat: []
        };

        groupsData.unshift(newGroup);
        renderGroupList(groupSearch?.value || '');
        selectGroup(newGroup.id);
        closeModal();
        showToast(`Group "${name}" created`);
      });
    })();
  </script>
</body>
</html>


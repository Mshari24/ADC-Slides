<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile &amp; Settings</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="home-body profile-body">
  <div class="profile-root">
    <header class="profile-header">
      <button id="btn-profile-back" class="profile-back-button" type="button" aria-label="Back to home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span>Back</span>
      </button>
      <div class="profile-header-text">
        <h1 class="profile-page-title">User Profile &amp; Settings</h1>
      </div>
      <div class="profile-header-avatar">
        <div class="profile-header-icon" id="profile-header-initial">H</div>
        <span class="profile-header-name" id="profile-header-name">Huda-Alzahrani</span>
      </div>
    </header>

    <main class="profile-main">
      <section class="profile-section">
        <div class="profile-grid">
          <article class="profile-card identity-card">
            <div class="identity-card-hero">
              <div class="profile-avatar-wrapper">
                <img id="profile-avatar" class="profile-avatar-img" alt="Profile picture" />
                <div class="profile-avatar-placeholder" id="profile-avatar-initial">H</div>
              </div>
              <h2 class="identity-heading" id="profile-name">Huda-Alzahrani</h2>
            </div>
            <div class="identity-core-grid">
              <div class="identity-core-field">
                <span class="identity-field-label">Employee ID</span>
                <span class="identity-field-value" id="profile-employee-id">AD-18012</span>
              </div>
              <div class="identity-core-field">
                <span class="identity-field-label">Department</span>
                <span class="identity-field-value" id="profile-department">Digital Strategy Office</span>
              </div>
              <div class="identity-core-field">
                <span class="identity-field-label">Job Title</span>
                <span class="identity-field-value" id="profile-job-title">UX/UI Designer</span>
              </div>
            </div>
            <div class="identity-contact">
              <h3 class="identity-contact-title">EMAIL</h3>
              <p class="identity-contact-value" id="profile-email-value">huda.alzahrani@aramcodigital.com</p>
            </div>
          </article>

          <article class="security-card account-security-card">
            <div class="security-card-header">
            </div>
            <div class="account-security-body">
              <div class="account-security-section">
                <h3 class="account-security-title">Security</h3>
                <button id="btn-change-pass" class="btn-change-password" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  Change Password
                </button>
              </div>

              <div class="account-security-section">
                <h3 class="account-security-title">Preferences</h3>
                <div class="security-switch-group">
                  <label class="security-toggle">
                    <span class="security-toggle-label">Dark Mode</span>
                    <input id="toggle-dark" type="checkbox" />
                    <span class="security-toggle-slider" aria-hidden="true"></span>
                  </label>
                  <label class="security-toggle">
                    <span class="security-toggle-label">Email Notifications</span>
                    <input id="toggle-email" type="checkbox" checked />
                    <span class="security-toggle-slider" aria-hidden="true"></span>
                  </label>
                </div>
              </div>
            </div>
          </article>
        </div>
      </section>

      <section class="profile-logout">
        <button id="btn-logout" class="btn-logout" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Log Out
        </button>
      </section>

    </main>
  </div>

  <script src="../storage.js"></script>
  <script src="../dark-mode.js"></script>
  <script>
    (function () {
      const storage = window.AccountStorage;
      if (!storage) return;

      const redirectToLogin = () => {
        const loginUrl = new URL('../login.html', window.location.href);
        loginUrl.searchParams.set('redirect', 'profile/');
        window.location.replace(loginUrl.toString());
      };

      let account = storage.getCurrentAccount(true);
      if (!account) {
        redirectToLogin();
        return;
      }

      const nameHeading = document.getElementById('profile-name');
      const emailValueEl = document.getElementById('profile-email-value');
      const avatarInitial = document.getElementById('profile-avatar-initial');
      const headerInitial = document.getElementById('profile-header-initial');
      const headerName = document.getElementById('profile-header-name');
      const profileAvatarImg = document.getElementById('profile-avatar');
      const employeeIdField = document.getElementById('profile-employee-id');
      const departmentField = document.getElementById('profile-department');
      const jobTitleField = document.getElementById('profile-job-title');
      const backButton = document.getElementById('btn-profile-back');
      const params = new URLSearchParams(window.location.search);

      const computeInitials = (value, fallbackEmail) => {
        const text = (value || '').trim();
        if (!text && fallbackEmail) {
          return fallbackEmail.slice(0, 2).toUpperCase();
        }
        const parts = text.split(/\s+/).filter(Boolean);
        if (!parts.length) {
          return fallbackEmail ? fallbackEmail.slice(0, 2).toUpperCase() : 'AD';
        }
        return parts.map(part => part.charAt(0).toUpperCase()).join('').slice(0, 2);
      };

      const syncAccount = () => {
        account = storage.getCurrentAccount(true) || account;
        return account;
      };

      const updateProfileUI = () => {
        const current = syncAccount();
        const profile = current.profile || {};
        const displayName = profile.displayName || profile.formattedName?.replace(/-/g, ' ') || 'User';
        const initials = profile.initials || computeInitials(displayName, profile.displayEmail);

        if (nameHeading) nameHeading.textContent = displayName;
        if (headerName) headerName.textContent = displayName;

        const emailText = profile.displayEmail || profile.email || '';
        if (emailValueEl) {
          emailValueEl.textContent = emailText;
        }

        if (avatarInitial) avatarInitial.textContent = initials || 'AD';
        if (headerInitial) headerInitial.textContent = initials || 'AD';

        if (profileAvatarImg && profile.avatarUrl) {
          profileAvatarImg.src = profile.avatarUrl;
          profileAvatarImg.style.display = 'block';
          if (avatarInitial) avatarInitial.style.display = 'none';
        }

        if (employeeIdField) employeeIdField.textContent = profile.employeeId || '—';
        if (departmentField) departmentField.textContent = profile.department || '—';
        if (jobTitleField) jobTitleField.textContent = profile.jobTitle || '—';
      };

      const showToast = (message, duration = 1500) => {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.position = 'fixed';
        toast.style.bottom = '24px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'var(--primary, #005b49)';
        toast.style.color = '#ffffff';
        toast.style.padding = '10px 16px';
        toast.style.borderRadius = '12px';
        toast.style.boxShadow = '0 16px 36px rgba(15, 44, 103, 0.28)';
        toast.style.fontWeight = '600';
        toast.style.zIndex = '9999';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
      };

      const applyProfileChanges = (updater) => {
        storage.updateCurrentAccount((acc) => {
          updater(acc);
          const profile = acc.profile || {};
          profile.initials = computeInitials(profile.displayName || '', profile.displayEmail || profile.email);
          profile.firstInitial = profile.initials.charAt(0) || 'A';
          acc.profile = profile;
        });
        updateProfileUI();
      };

      const nameParam = (params.get('name') || '').trim();
      if (nameParam) {
        applyProfileChanges((acc) => {
          acc.profile.displayName = nameParam;
          acc.profile.formattedName = nameParam.replace(/\s+/g, '-');
        });
      }

      const btnChange = document.getElementById('btn-change-pass');
      const modal = document.createElement('div');
      modal.className = 'modal hidden';
      modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cp-title">
          <h3 id="cp-title">Change Password</h3>
          <form id="cp-form">
            <label class="form-item"><span>Old Password</span><input type="password" required /></label>
            <label class="form-item"><span>New Password</span><input id="cp-new" type="password" required minlength="6" /></label>
            <label class="form-item"><span>Confirm New Password</span><input id="cp-confirm" type="password" required minlength="6" /></label>
            <div class="modal-actions">
              <button type="button" id="cp-cancel" class="btn">Cancel</button>
              <button type="submit" class="btn-primary">Save</button>
            </div>
          </form>
        </div>`;
      document.body.appendChild(modal);

      const closePasswordModal = () => modal.classList.add('hidden');
      const openPasswordModal = () => modal.classList.remove('hidden');

      btnChange && btnChange.addEventListener('click', openPasswordModal);
      modal.querySelector('#cp-cancel').addEventListener('click', closePasswordModal);
      modal.querySelector('.modal-backdrop').addEventListener('click', closePasswordModal);
      modal.querySelector('#cp-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const newPassword = modal.querySelector('#cp-new');
        const confirmPassword = modal.querySelector('#cp-confirm');
        if (newPassword.value !== confirmPassword.value) {
          alert('Passwords do not match');
          return;
        }
        closePasswordModal();
        showToast('Password updated');
      });

      const darkModeToggle = document.getElementById('toggle-dark');
      const accountPreferences = account.preferences || {};
      
      // Initialize dark mode using the utility
      if (window.DarkMode) {
        window.DarkMode.init();
        if (darkModeToggle) {
          darkModeToggle.checked = window.DarkMode.isEnabled();
        }
      } else {
        // Fallback if dark-mode.js not loaded
        if (accountPreferences.darkMode) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
        }
        if (darkModeToggle) {
          darkModeToggle.checked = !!accountPreferences.darkMode;
        }
      }
      
      // Handle toggle change
      if (darkModeToggle) {
        darkModeToggle.addEventListener('change', () => {
          if (window.DarkMode) {
            window.DarkMode.set(darkModeToggle.checked);
            showToast(darkModeToggle.checked ? 'Dark mode enabled' : 'Dark mode disabled', 1500);
          } else {
            // Fallback
            document.body.classList.toggle('dark-mode', darkModeToggle.checked);
            document.documentElement.classList.toggle('dark-mode', darkModeToggle.checked);
            storage.updateCurrentAccount((acc) => {
              acc.preferences = acc.preferences || {};
              acc.preferences.darkMode = darkModeToggle.checked;
            });
          }
        });
      }

      const emailToggle = document.getElementById('toggle-email');
      if (emailToggle) {
        emailToggle.checked = accountPreferences.emailNotifications !== false;
        emailToggle.addEventListener('change', () => {
          storage.updateCurrentAccount((acc) => {
            acc.preferences = acc.preferences || {};
            acc.preferences.emailNotifications = emailToggle.checked;
          });
          showToast(emailToggle.checked ? 'Email notifications enabled' : 'Email notifications disabled', 1200);
        });
      }

      const clearSessionArtifacts = () => {
        const currentEmail = storage.getCurrentAccountEmail();
        if (currentEmail) {
          storage.updateAccount(currentEmail, (acc) => {
            acc.preferences = acc.preferences || {};
            acc.preferences.rememberLogin = false;
          });
        }
        storage.clearCurrentAccount();
        storage.clearLegacyProfileKeys();
        try { sessionStorage.clear(); } catch (_) {}
        try {
          document.cookie.split(';').forEach(cookie => {
            const eqPos = cookie.indexOf('=');
            const name = eqPos > -1 ? cookie.slice(0, eqPos) : cookie;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
          });
        } catch (_) {}
      };

      const btnLogout = document.getElementById('btn-logout');
      btnLogout && btnLogout.addEventListener('click', () => {
        if (confirm('Are you sure you want to log out?')) {
          clearSessionArtifacts();
          window.location.href = '../login.html';
        }
      });

      const loadAuthenticatedProfile = async () => {
        try {
          const response = await fetch('/api/session/profile', { credentials: 'include' });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          if (!data) return;

          storage.updateCurrentAccount((acc) => {
            const profile = acc.profile || {};
            profile.displayEmail = data.email || profile.displayEmail;
            profile.email = (data.email || profile.email || '').toLowerCase();
            profile.displayName = data.displayName || profile.displayName;
            profile.formattedName = (data.displayName || profile.displayName || '').replace(/\s+/g, '-');
            profile.initials = computeInitials(profile.displayName, profile.displayEmail || profile.email);
            profile.firstInitial = profile.initials.charAt(0) || 'A';
            profile.employeeId = data.employeeId || profile.employeeId;
            profile.department = data.department || profile.department;
            profile.jobTitle = data.jobTitle || profile.jobTitle;
            profile.phone = data.phone || profile.phone;
            profile.avatarUrl = data.avatarUrl || profile.avatarUrl;
            acc.profile = profile;
          });
        } catch (error) {
          console.warn('Failed to load authenticated profile, falling back to defaults.', error);
        } finally {
          updateProfileUI();
        }
      };

      updateProfileUI();
      loadAuthenticatedProfile();
      backButton && backButton.addEventListener('click', () => {
        window.location.href = '../home.html';
      });
    })();
  </script>
</body>
</html>


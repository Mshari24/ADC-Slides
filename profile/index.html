<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile &amp; Settings</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="home-body">
  <div class="home-root">
    <aside class="home-sidebar" aria-label="Primary navigation">
      <div class="sidebar-user">
        <a class="sidebar-avatar-link" href="/profile/" title="User Profile &amp; Settings" aria-label="Open profile page">
          <div class="sidebar-avatar" aria-hidden="true">H</div>
        </a>
      </div>
      <a class="sb-item home-entry" href="/home.html" title="Home">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
        </div>
        <span class="sb-label">Home</span>
      </a>
      <a class="sb-item new-entry" href="/index.html" title="New">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </div>
        <span class="sb-label">New</span>
      </a>
      <a class="sb-item" href="/groups.html" title="Groups">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <span class="sb-label">Groups</span>
      </a>
      <a class="sb-item" href="/project.html" title="Projects">
        <div class="sb-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </div>
        <span class="sb-label">Projects</span>
      </a>
      <a class="sb-item" href="https://outlook.office.com/mail/" target="_blank" rel="noopener noreferrer" title="Outlook">
        <div class="sb-icon">
          <img src="../pic/Outlook_on_the_web-Logo.wine.png" alt="Outlook" />
        </div>
        <span class="sb-label">Outlook</span>
      </a>
      <a class="sb-item" href="https://teams.microsoft.com/" target="_blank" rel="noopener noreferrer" title="Microsoft Teams">
        <div class="sb-icon">
          <img src="../pic/Microsoft-Teams-Logo.png" alt="Microsoft Teams" />
        </div>
        <span class="sb-label">Teams</span>
      </a>
      <a class="sb-item logout-link" href="../login.html" title="Log out">
        <div class="sb-icon logout-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </div>
        <span class="sb-label">Logout</span>
      </a>
    </aside>

    <main class="home-main">
      <header class="home-top">
        <h1 class="greeting page-title">User Profile &amp; Settings</h1>
        <div class="top-logo">
          <img src="../pic/aramco-digital.png" alt="Aramco Digital" class="header-logo" />
        </div>
      </header>

      <section class="home-middle">
        <div class="profile-card identity-card">
          <div class="identity-card-head">
            <div class="identity-avatar-block">
              <div class="profile-avatar-wrapper">
                <img id="profile-avatar" class="profile-avatar-img" alt="Profile picture" />
                <div class="profile-avatar-placeholder" id="profile-avatar-initial">H</div>
              </div>
              <button id="btn-avatar" class="btn-upload-avatar" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Photo
              </button>
              <input id="input-avatar" type="file" accept="image/*" style="display:none" />
            </div>
            <div class="identity-heading">
              <h2 id="profile-name">Huda-Alzahrani</h2>
              <p class="identity-subtitle" id="profile-email-label">huda.alzahrani@aramcodigital.com</p>
            </div>
          </div>
          <div class="identity-core-grid">
            <div class="identity-core-field">
              <span class="identity-field-label">Employee ID</span>
              <span class="identity-field-value" id="profile-employee-id">AD-18012</span>
            </div>
            <div class="identity-core-field">
              <span class="identity-field-label">Department</span>
              <span class="identity-field-value" id="profile-department">Digital Strategy Office</span>
            </div>
            <div class="identity-core-field">
              <span class="identity-field-label">Job Title</span>
              <span class="identity-field-value" id="profile-job-title">UX/UI Designer</span>
            </div>
          </div>
          <form id="profile-form" class="identity-form" onsubmit="return false;">
            <div class="identity-form-grid">
              <label class="profile-form-item">
                <span class="profile-label">Corporate Email</span>
                <input id="email-address" type="email" value="huda.alzahrani@aramcodigital.com" class="profile-input readonly" readonly />
              </label>
              <label class="profile-form-item">
                <span class="profile-label">Preferred Display Name</span>
                <input id="display-name" type="text" value="Huda-Alzahrani" class="profile-input" />
              </label>
              <label class="profile-form-item">
                <span class="profile-label">Contact Phone</span>
                <input id="contact-phone" type="tel" value="+966 50 123 4567" class="profile-input" />
              </label>
            </div>
            <div class="profile-actions">
              <button id="btn-save" class="btn-save-profile" type="submit">Save Changes</button>
            </div>
          </form>
        </div>
        <div class="security-card account-security-card">
          <div class="security-card-header">
            <h2>Account &amp; Security</h2>
            <p class="security-card-subtitle">Manage your credentials and communication settings.</p>
          </div>
          <div class="account-security-body">
            <div class="account-security-section">
              <h3 class="account-security-title">Security</h3>
              <p class="account-security-text">Update your password regularly to keep your account secure.</p>
              <button id="btn-change-pass" class="btn-change-password" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Change Password
              </button>
            </div>

            <div class="account-security-section">
              <h3 class="account-security-title">Preferences</h3>
              <div class="security-switch-group">
                <label class="security-toggle">
                  <span class="security-toggle-label">Dark Mode</span>
                  <input id="toggle-dark" type="checkbox" />
                  <span class="security-toggle-slider" aria-hidden="true"></span>
                </label>
                <label class="security-toggle">
                  <span class="security-toggle-label">Email Notifications</span>
                  <input id="toggle-email" type="checkbox" checked />
                  <span class="security-toggle-slider" aria-hidden="true"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="logout-section">
        <button id="btn-logout" class="btn-logout" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Log Out
        </button>
      </div>
    </main>
  </div>

  <script>
    (function() {
      const params = new URLSearchParams(location.search);
      const nameParam = (params.get('name') || '').trim();
      const emailParam = (params.get('email') || '').trim();
      const sidebarAvatar = document.querySelector('.sidebar-avatar');
      const nameHeading = document.getElementById('profile-name');
      const display = document.getElementById('display-name');
      const emailInput = document.getElementById('email-address');
      const TEMPLATE_TOKEN = '{{';

      function sanitizeTemplateValue(value, fallback = '') {
        if (!value) return fallback;
        const trimmed = value.trim();
        if (!trimmed || trimmed.includes(TEMPLATE_TOKEN)) return fallback;
        return trimmed;
      }

      function getStoredValue(key) {
        try {
          return window.localStorage.getItem(key) || '';
        } catch (error) {
          console.warn('Unable to access localStorage key:', key, error);
          return '';
        }
      }

      const emailLabel = document.getElementById('profile-email-label');
      const avatarInitial = document.getElementById('profile-avatar-initial');
      const employeeIdField = document.getElementById('profile-employee-id');
      const departmentField = document.getElementById('profile-department');
      const jobTitleField = document.getElementById('profile-job-title');
      const phoneField = document.getElementById('contact-phone');

      const storedFormattedName = sanitizeTemplateValue(getStoredValue('adSlidesUserName'));
      const storedEmail = sanitizeTemplateValue(getStoredValue('adSlidesUserEmail'));
      const storedInitial = sanitizeTemplateValue(getStoredValue('adSlidesUserInitials')) || (storedFormattedName ? storedFormattedName.charAt(0).toUpperCase() : '');

      if (!storedEmail) {
        const loginUrl = new URL('../login.html', window.location.href);
        loginUrl.searchParams.set('redirect', 'profile/');
        window.location.replace(loginUrl.toString());
        return;
      }

      const FALLBACK_PROFILE = {
        formattedName: storedFormattedName || 'Huda-Alzahrani',
        email: storedEmail || 'huda.alzahrani@aramcodigital.com',
        employeeId: 'AD-18012',
        department: 'Digital Strategy Office',
        jobTitle: 'UX/UI Designer',
        contactPhone: '+966 50 123 4567',
        initial: storedInitial || 'H'
      };

      function formatDisplayNameFromEmail(email) {
        if (!email || !email.includes('@')) return '';
        const [local] = email.split('@');
        const segments = local.split(/[\.\-_]/).filter(Boolean);
        if (segments.length === 0) return '';
        if (segments.length === 1) {
          return segments[0].charAt(0).toUpperCase() + segments[0].slice(1);
        }
        const first = segments[0];
        const last = segments[segments.length - 1];
        return `${first.charAt(0).toUpperCase() + first.slice(1)}-${last.charAt(0).toUpperCase() + last.slice(1)}`;
      }

      function applyIdentityName(raw) {
        const text = (raw || '').trim();
        if (nameHeading) {
          nameHeading.textContent = text || FALLBACK_PROFILE.formattedName;
        }
        if (sidebarAvatar) {
          sidebarAvatar.textContent = text ? text.charAt(0).toUpperCase() : FALLBACK_PROFILE.initial;
        }
        if (avatarInitial) {
          avatarInitial.textContent = text ? text.charAt(0).toUpperCase() : FALLBACK_PROFILE.initial;
        }
      }

      function applyEmailLabel(value) {
        if (emailLabel) {
          emailLabel.textContent = value || FALLBACK_PROFILE.email;
        }
      }

      function seedFromParams(replaceExisting = false) {
        const existingEmail = emailInput ? sanitizeTemplateValue(emailInput.value) : '';
        const finalEmail =
          sanitizeTemplateValue(emailParam) ||
          storedEmail ||
          existingEmail ||
          FALLBACK_PROFILE.email;
        if (emailInput && (!emailInput.value || replaceExisting)) {
          emailInput.value = finalEmail || '';
        }

        const existingDisplay =
          display && display.value && !replaceExisting ? sanitizeTemplateValue(display.value) : '';
        const initialDisplay =
          sanitizeTemplateValue(nameParam) ||
          storedFormattedName ||
          existingDisplay ||
          formatDisplayNameFromEmail(finalEmail) ||
          FALLBACK_PROFILE.formattedName;

        if (display && (!display.value || replaceExisting)) {
          display.value = initialDisplay;
        }

        applyIdentityName(initialDisplay);
        applyEmailLabel(finalEmail);

        if (employeeIdField && (!employeeIdField.textContent || replaceExisting)) {
          employeeIdField.textContent = FALLBACK_PROFILE.employeeId;
        }
        if (departmentField && (!departmentField.textContent || replaceExisting)) {
          departmentField.textContent = FALLBACK_PROFILE.department;
        }
        if (jobTitleField && (!jobTitleField.textContent || replaceExisting)) {
          jobTitleField.textContent = FALLBACK_PROFILE.jobTitle;
        }
        if (phoneField && (!phoneField.value || replaceExisting)) {
          phoneField.value = FALLBACK_PROFILE.contactPhone;
        }
      }

      display && display.addEventListener('input', (e) => {
        applyIdentityName(e.target.value);
      });

      // Profile interactions
      const inputAvatar = document.getElementById('input-avatar');
      const btnAvatar = document.getElementById('btn-avatar');
      const imgAvatar = document.getElementById('profile-avatar');
      const avatarPlaceholder = document.querySelector('.profile-avatar-placeholder');
      
      btnAvatar && btnAvatar.addEventListener('click', () => inputAvatar && inputAvatar.click());
      inputAvatar && inputAvatar.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          imgAvatar.src = reader.result;
          if (avatarPlaceholder) avatarPlaceholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      const form = document.getElementById('profile-form');
      form && form.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = document.createElement('div');
        msg.textContent = 'Saved';
        msg.style.position='fixed'; msg.style.bottom='16px'; msg.style.left='50%'; msg.style.transform='translateX(-50%)';
        msg.style.background='var(--primary)'; msg.style.color='#fff'; msg.style.padding='10px 14px'; msg.style.borderRadius='10px'; msg.style.zIndex='9999';
        document.body.appendChild(msg); setTimeout(()=>msg.remove(), 1500);
        if (display && display.value) {
          applyIdentityName(display.value);
        }
        if (emailInput) {
          applyEmailLabel(sanitizeTemplateValue(emailInput.value));
        }
      });

      async function loadAuthenticatedProfile() {
        try {
          const response = await fetch('/api/session/profile', { credentials: 'include' });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          const {
            email,
            firstName,
            lastName,
            employeeId,
            department,
            jobTitle,
            phone,
            displayName,
            avatarUrl
          } = data || {};

          const resolvedEmail =
            sanitizeTemplateValue(email) ||
            sanitizeTemplateValue(emailInput?.value) ||
            FALLBACK_PROFILE.email;
          if (emailInput) {
            emailInput.value = resolvedEmail;
          }
          applyEmailLabel(resolvedEmail);

          const resolvedDisplay =
            sanitizeTemplateValue(displayName) ||
            [sanitizeTemplateValue(firstName), sanitizeTemplateValue(lastName)]
              .filter(Boolean)
              .join('-') ||
            formatDisplayNameFromEmail(resolvedEmail) ||
            sanitizeTemplateValue(display?.value) ||
            FALLBACK_PROFILE.formattedName;

          if (display) {
            display.value = resolvedDisplay;
          }
          applyIdentityName(resolvedDisplay);

          if (employeeIdField) {
            employeeIdField.textContent = sanitizeTemplateValue(employeeId) || FALLBACK_PROFILE.employeeId;
          }
          if (departmentField) {
            departmentField.textContent = sanitizeTemplateValue(department) || FALLBACK_PROFILE.department;
          }
          if (jobTitleField) {
            jobTitleField.textContent = sanitizeTemplateValue(jobTitle) || FALLBACK_PROFILE.jobTitle;
          }
          if (phoneField) {
            phoneField.value = sanitizeTemplateValue(phone) || FALLBACK_PROFILE.contactPhone;
          }

          if (imgAvatar && avatarUrl) {
            imgAvatar.src = avatarUrl;
            if (avatarPlaceholder) avatarPlaceholder.style.display = 'none';
          }
        } catch (error) {
          console.warn('Failed to load authenticated profile, falling back to defaults.', error);
        } finally {
          seedFromParams(true);
        }
      }

      seedFromParams();
      loadAuthenticatedProfile();

      // Security modal: Change Password
      const btnChange = document.getElementById('btn-change-pass');
      const modal = document.createElement('div');
      modal.className = 'modal hidden';
      modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cp-title">
          <h3 id="cp-title">Change Password</h3>
          <form id="cp-form">
            <label class="form-item"><span>Old Password</span><input type="password" required /></label>
            <label class="form-item"><span>New Password</span><input id="cp-new" type="password" required minlength="6" /></label>
            <label class="form-item"><span>Confirm New Password</span><input id="cp-confirm" type="password" required minlength="6" /></label>
            <div class="modal-actions">
              <button type="button" id="cp-cancel" class="btn">Cancel</button>
              <button type="submit" class="btn-primary">Save</button>
            </div>
          </form>
        </div>`;
      document.body.appendChild(modal);
      function openModal(){ modal.classList.remove('hidden'); }
      function closeModal(){ modal.classList.add('hidden'); }
      btnChange && btnChange.addEventListener('click', openModal);
      modal.querySelector('#cp-cancel').addEventListener('click', closeModal);
      modal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
      modal.querySelector('#cp-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const a = modal.querySelector('#cp-new');
        const b = modal.querySelector('#cp-confirm');
        if (a.value !== b.value) { alert('Passwords do not match'); return; }
        closeModal();
        const n = document.createElement('div'); n.textContent='Password updated';
        n.style.position='fixed'; n.style.bottom='16px'; n.style.left='50%'; n.style.transform='translateX(-50%)';
        n.style.background='var(--primary)'; n.style.color='#fff'; n.style.padding='10px 14px'; n.style.borderRadius='10px'; n.style.zIndex='9999';
        document.body.appendChild(n); setTimeout(()=>n.remove(),1500);
      });

      // Dark Mode toggle
      const tDark = document.getElementById('toggle-dark');
      const saved = localStorage.getItem('darkMode') === 'true';
      if (saved) document.body.classList.add('dark-mode');
      tDark && (tDark.checked = saved);
      tDark && tDark.addEventListener('change', () => {
        document.body.classList.toggle('dark-mode', tDark.checked);
        localStorage.setItem('darkMode', String(tDark.checked));
      });

      // Language selector
      const emailToggle = document.getElementById('toggle-email');
      emailToggle && emailToggle.addEventListener('change', () => {
        const n = document.createElement('div'); n.textContent = emailToggle.checked ? 'Email notifications enabled' : 'Email notifications disabled';
        n.style.position='fixed'; n.style.bottom='16px'; n.style.left='50%'; n.style.transform='translateX(-50%)';
        n.style.background='var(--primary)'; n.style.color='#fff'; n.style.padding='10px 14px'; n.style.borderRadius='10px'; n.style.zIndex='9999';
        document.body.appendChild(n); setTimeout(()=>n.remove(), 1200);
      });

      // Log Out
      function clearSessionArtifacts() {
        const keys = ['darkMode', 'language', 'authToken', 'sessionToken', 'emailNotifications'];
        keys.forEach(key => {
          try { localStorage.removeItem(key); } catch (_) {}
        });
        try { sessionStorage.clear(); } catch (_) {}
        try {
          document.cookie.split(';').forEach(cookie => {
            const eqPos = cookie.indexOf('=');
            const name = eqPos > -1 ? cookie.slice(0, eqPos) : cookie;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
          });
        } catch (_) {}
      }

      const btnLogout = document.getElementById('btn-logout');
      btnLogout && btnLogout.addEventListener('click', () => {
        if (confirm('Are you sure you want to log out?')) {
          clearSessionArtifacts();
          window.location.href = '/login.html';
        }
      });
    })();
  </script>
</body>
</html>

